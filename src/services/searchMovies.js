const Links = {
  Netflix: 'https://www.netflix.com/',
  'Amazon Prime Video': 'https://www.amazon.com/Amazon-Video/b/?ie=UTF8&node=2858778011',
  'Disney Plus': 'https://www.disneyplus.com/',
  'Apple TV Plus': 'https://www.apple.com/apple-tv-plus/',
  'Apple TV': 'https://www.apple.com/tv/',
  Hulu: 'https://www.hulu.com/',
  Crunchyroll: 'https://www.crunchyroll.com/',
  fuboTV: 'https://www.fubo.tv/welcome',
  'HBO Max': 'https://www.hbomax.com/',
  Max: 'https://maxtvgo.com/',
  'Max Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'MGM Plus Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Crunchyroll Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  Peacock: 'https://www.peacocktv.com/',
  'Peacock Premium': 'https://www.peacocktv.com/',
  Kocowa: 'https://www.kocowa.com/',
  'Amazon Video': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Google Play Movies': 'https://play.google.com/store/movies',
  YouTube: 'https://www.youtube.com/',
  'Paramount Plus': 'https://www.paramountplus.com/',
  'Paramount+ with Showtime': 'https://www.paramountplus.com/',
  'Paramount Plus Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Starz Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'AMC Plus Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Britbox Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Paramount+ Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Discovery+ Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'AMC+ Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Funimation Now': 'https://www.funimation.com/',
  'The Roku Channel': 'https://www.roku.com/',
  'Showtime Roku Premium Channel': 'https://www.roku.com/',
  'Paramount+ Roku Premium Channel': 'https://www.roku.com/',
  'Starz Roku Premium Channel': 'https://www.roku.com/',
  'AMC+ Roku Premium Channel': 'https://www.roku.com/',
  'Showtime Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'AMC+': 'https://www.amcplus.com/',
  'MGM Plus Roku Premium Channel': 'https://www.roku.com/',
  'YouTube Premium': 'https://www.youtube.com/premium',
  'YouTube Free': 'https://www.youtube.com/',
  Hoopla: 'https://www.hoopladigital.com/',
  'The CW': 'https://www.cwtv.com/',
  Vudu: 'https://www.vudu.com/',
  'VUDU Free': 'https://www.vudu.com/',
  Starz: 'https://www.starz.com/',
  Showtime: 'https://www.sho.com/',
  'Criterion Channel': 'https://www.criterionchannel.com/',
  PBS: 'https://www.pbs.org/',
  Pantaflix: 'https://www.pantaflix.com/',
  FXNow: 'https://www.fxnetworks.com/',
  'Tubi TV': 'https://tubitv.com/',
  'Comedy Central': 'https://www.cc.com/',
  Kanopy: 'https://www.kanopy.com/',
  'Microsoft Store': 'https://www.microsoft.com/en-us/store/movies-and-tv',
  Redbox: 'https://www.redbox.com/',
  'Sun Nxt': 'https://www.sunnxt.com/',
  ABC: 'https://abc.com/',
  Crackle: 'https://www.sonycrackle.com/',
  DIRECTV: 'https://www.directv.com/',
  AMC: 'https://www.amc.com/',
  Fandor: 'https://www.fandor.com/',
  'Curiosity Stream': 'https://www.curiositystream.com/',
  'MGM Plus': 'https://www.mgmplus.com/',
  Freeform: 'https://freeform.go.com/',
  History: 'https://www.history.com/',
  Lifetime: 'https://www.mylifetime.com/',
  Shudder: 'https://www.shudder.com/',
  Syfy: 'https://www.syfy.com/',
  'Acorn TV': 'https://acorn.tv/',
  realeyz: 'https://www.realeyz.com/',
  Screambox: 'https://www.screambox.com/',
  'Sundance Now': 'https://www.sundancenow.com/',
  Popcornflix: 'https://www.popcornflix.com/',
  GuideDoc: 'https://guidedoc.tv/',
  BritBox: 'https://www.britbox.com/',
  MUBI: 'https://mubi.com/',
  'Netflix Kids': 'https://www.netflix.com/',
  Boomerang: 'https://www.boomerang.com/',
  'Urban Movie Channel': 'https://www.urbanmoviechannel.com/',
  'History Vault': 'https://www.historyvault.com/',
  'Eros Now': 'https://erosnow.com/',
  Pantaya: 'https://www.pantaya.com/',
  'Yupp TV': 'https://www.yupptv.com/',
  'Dove Channel': 'https://dovechannel.com/',
  'Magnolia Selects': 'https://www.magnoliaselects.com/',
  'WWE Network': 'https://www.wwe.com/',
  'Nickhits Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Noggin Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Smithsonian Channel': 'https://www.smithsonianchannel.com/',
  'Laugh Out Loud': 'https://www.laughoutloud.com/',
  'Pure Flix': 'https://pureflix.com/',
  'PBS Kids Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Lifetime Movie Club': 'https://www.lifetimemovieclub.com/',
  'Boomerang Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Cinemax Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Hallmark Movies Now Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'PBS Masterpiece Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Hallmark Movies': 'https://www.hallmarkmoviesandmysteries.com/',
  'MZ Choice Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Viewster Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  Spamflix: 'https://spamflix.com/',
  'Pluto TV': 'https://www.pluto.tv/',
  HiDive: 'https://www.hidive.com/',
  VIX: 'https://www.vix.com/',
  Topic: 'https://www.topic.com/',
  'Night Flight Plus': 'https://www.nightflightplus.com/',
  Retrocrush: 'https://www.retrocrush.tv/',
  Classix: 'https://classix.tv/',
  Dekkoo: 'https://www.dekkoo.com/',
  'Shout! Factory TV': 'https://www.shoutfactorytv.com/',
  OVID: 'https://ovid.tv/',
  'Chai Flicks': 'https://www.chaiflicks.com/',
  'Shudder Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'MUBI Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'BritBox Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'AcornTV Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Fandor Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Screambox Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'The Film Detective': 'https://thefilmdetective.tv/',
  'USA Network': 'https://www.usanetwork.com/',
  FlixFling: 'https://www.flixfling.com/',
  'Bet+ Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Rakuten Viki': 'https://www.viki.com/',
  'AMC on Demand': 'https://www.amc.com/',
  TCM: 'http://www.tcm.com/',
  TNT: 'https://www.tntdrama.com/',
  'Darkmatter TV': 'https://www.darkmattertv.com/',
  'BBC America': 'https://www.bbcamerica.com/',
  IndieFlix: 'https://www.indieflix.com/',
  'Here TV': 'https://www.heretv.com/',
  'Flix Premiere': 'https://flixpremiere.com/',
  TBS: 'https://www.tbs.com/',
  AsianCrush: 'https://www.asiancrush.com/',
  FILMRISE: 'https://www.filmrise.com/',
  Revry: 'https://revry.tv/',
  DOCSVILLE: 'https://www.docsville.com/',
  'Spectrum On Demand': 'https://www.spectrum.net/on-demand/',
  'Hi-YAH': 'https://www.hiyahtv.com/',
  'tru TV': 'https://www.trutv.com/',
  DisneyNOW: 'https://disneynow.go.com/',
  ARROW: 'https://www.arrow-player.com/',
  Plex: 'https://www.plex.tv/',
  'Plex Player': 'https://www.plex.tv/',
  'WOW Presents Plus': 'https://www.wowpresentsplus.com/',
  'Magellan TV': 'https://www.magellantv.com/',
  BroadwayHD: 'https://www.broadwayhd.com/',
  Filmzie: 'https://www.filmzie.com/',
  MovieSaints: 'https://moviesaints.com/',
  'Dogwoof On Demand': 'https://ondemand.dogwoof.com/',
  'True Story': 'https://www.truestory.film/',
  'DocAlliance Films': 'https://dafilms.com/',
  KoreaOnDemand: 'https://koreaondemand.tv/',
  Hoichoi: 'https://www.hoichoi.tv/',
  iQIYI: 'https://www.iq.com/',
  Metrograph: 'https://metrograph.com/',
  'Alamo on Demand': 'https://ondemand.drafthouse.com/',
  Freevee: 'https://freevee.com/',
  'Public Domain Movies': 'https://publicdomainmovies.info/',
  'Kino Now': 'https://kinonow.com/',
  Eventive: 'https://watch.eventive.org/',
  Cultpix: 'https://www.cultpix.com/',
  aha: 'https://www.aha.video/',
  'FilmBox+': 'https://www.filmboxplus.com/',
  'ShortsTV Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Bet+': 'https://www.bet.plus/',
  Takflix: 'https://www.takflix.com/',
  Klassiki: 'https://klassiki.com/',
  'Starz Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Netflix basic with Ads': 'https://www.netflix.com/',
  'Cohen Media Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  Popflick: 'https://www.popflick.tv/',
  Viaplay: 'https://viaplay.com/',
  Runtime: 'https://www.runtime.global/',
  Reveel: 'https://www.reveel.it/',
  'Angel Studios': 'https://angel.com/',
  Cineverse: 'https://www.cineverse.com/',
  'AD tv': 'https://www.adtv.com/',
  'Midnight Pulp': 'https://www.midnightpulp.com/',
  'Xumo Play': 'https://www.xumo.tv/',
  'National Geographic': 'https://www.nationalgeographic.com/',
  'Shahid VIP': 'https://www.shahid.net/',
  DistroTV: 'https://www.distrotv.com/',
  myfilmfriend: 'https://myfilmfriend.com/',
  'Outside Watch': 'https://www.outsidetv.com/',
  'Full Moon Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Univer Video': 'https://univervideo.com/',
  GlewedTV: 'https://www.glewed.tv/',
  'Hallmark Movies and Mysteries': 'https://www.hallmarkmoviesandmysteries.com/',
  'Noggin Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'A&E Crime Central Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Acorn TV Apple TV': 'https://www.apple.com/apple-tv/',
  'ALLBLK Apple TV channel': 'https://www.apple.com/apple-tv/',
  'UP Faith & Family Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Topic Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Shudder Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Showtime Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'ScreenPix Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'OUTtv Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Lifetime Movie Club Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Hallmark Movies Now Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Eros Now Select Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'CuriosityStream Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'Cinemax Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'BET+  Apple TV channel': 'https://www.apple.com/apple-tv/',
  'Carnegie Hall+ Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'IFC Films Unlimited Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'HISTORY Vault Apple TV Channel': 'https://www.apple.com/apple-tv/',
  'HISTORY Vault Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Carnegie Hall+ Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  'Troma NOW': 'https://troma.vhx.tv/',
  'Lifetime Movie Club Amazon Channel': 'https://www.amazon.com/Prime-Video/b/?ie=UTF8&node=2858778011',
  CBS: 'https://www.cbs.com/',
  'Film Movement Plus': 'https://www.filmmovementplus.com/'
}
// async function LoadLink () {
//   if (!Links) { // Verificar si los datos ya han sido cargados
//     const dataLink = await fetch('/src/Mocks/Links.json')
//     Links = await dataLink.json()
//   }
//   return Links // Devolver los datos de los enlaces
// }
const API = import.meta.env.VITE_TMDB_API_TOKEN
const options = {
  method: 'GET',
  headers: {
    accept: 'application/json',
    Authorization: `Bearer ${API}`
  }
}
// navigator.language
const END_POINTS = {
  search: (search) => `https://api.themoviedb.org/3/search/multi?query=${search}&include_adult=false&language=es-DO&page=1`,
  info: (query, type) => `https://api.themoviedb.org/3/${type}/${query}?language=es-DO&append_to_response=videos,similar,watch/providers`, // respuestas extra se colocan con  coma
  general: 'https://api.themoviedb.org/3/trending/all/day?&language=es-DO&append_to_response=images',
  movies: 'https://api.themoviedb.org/3/trending/movie/day?&language=es-DO&append_to_response=images',
  tv: 'https://api.themoviedb.org/3/trending/tv/day?&language=es-DO&append_to_response=images',
  images: (query, type) => `https://api.themoviedb.org/3/${type}/${query}/images`
}

export async function searchMovies ({ search, type }) {
// Carga el contenido del archivo .env
  let response
  if (search !== '' && search !== undefined) {
    try {
      response = await fetch(END_POINTS.search(search), options)
    } catch (e) {
      throw new Error('Error searching movies' + ' ' + e)
    }
  } else {
    if (type === 'tv') response = await fetch(END_POINTS.tv, options)
    else if (type === 'movie') response = await fetch(END_POINTS.movies, options)
    else response = await fetch(END_POINTS.general, options)
  }

  const data = await response.json()
  const movies = await data.results
  return mapMovies(movies)
}

export async function getMovieInfo (searchParameter) {
  const response = await fetch(END_POINTS.info(searchParameter.query, searchParameter.type), options)
  const data = await response.json()
  const movieInfo = await data
  return {
    title: movieInfo?.title ?? movieInfo?.name,
    info: movieInfo?.overview,
    image: `https://image.tmdb.org/t/p/w500/${movieInfo.poster_path}` ?? `https://image.tmdb.org/t/p/w500/${movieInfo.poster_path}`, // TODO: ADD DEFAULT MOVIE POSTER
    ranking: Number(movieInfo.vote_average.toFixed(1)),
    genres: movieInfo.genres[0].name,
    releaseDate: movieInfo.release_date ?? movieInfo.first_air_date,
    duration: timeConvert(movieInfo.runtime ?? movieInfo.episode_run_time),
    clip: movieInfo?.videos?.results[0]?.key ?? null,
    similar: mapMovies(movieInfo.similar.results.slice(0, 8)),
    providers: mapProviders(movieInfo['watch/providers'].results.DO)

  }
}

function mapProviders (providers) {
  const flatrateProviders = providers?.flatrate
  const freeProviders = providers?.free
  const buyProviders = providers?.buy

  const flatrateProviderList = flatrateProviders
    ? flatrateProviders.map(provider => {
      return {
        providerId: provider.provider_id,
        providerName: provider.provider_name,
        providerImg: `https://image.tmdb.org/t/p/w500/${provider.logo_path}`,
        link: Links[provider.provider_name] ?? ''
      }
    })
    : []

  const freeProviderList = freeProviders
    ? freeProviders.map(provider => {
      return {
        providerId: provider.provider_id,
        providerName: provider.provider_name,
        providerImg: `https://image.tmdb.org/t/p/w500/${provider.logo_path}`,
        link: Links[provider.provider_name] ?? ''
      }
    })
    : []
  const buyProviderList = buyProviders
    ? buyProviders.map(provider => {
      return {
        providerId: provider.provider_id,
        providerName: provider.provider_name,
        providerImg: `https://image.tmdb.org/t/p/w500/${provider.logo_path}`,
        link: Links[provider.provider_name] ?? ''
      }
    })
    : []

  const allProviders = new Set([...flatrateProviderList, ...freeProviderList, ...buyProviderList])
  const mappedProviders = [...allProviders]
  return mappedProviders.length !== 0 ? mappedProviders : null
}

function mapMovies (movies) {
  return movies?.map(movie => ({
    id: movie?.id ?? '',
    title: movie?.title ?? movie?.name ?? '',
    year: movie?.release_date?.substring(0, 4) ?? movie.first_air_date?.substring(0, 4),
    image: `https://image.tmdb.org/t/p/w500/${movie.poster_path}` ?? 'https://www.prokerala.com/movies/assets/img/no-poster-available.jpg',
    searchParameter: movie?.id,
    type: movie?.media_type
  }))
}

// export async function getGeneral () {
//   const response = await fetch(END_POINTS.general)
//   const data = await response.json()
//   const movies = data.results
//   return movies?.map(movie => ({
//     id: movie?.id ?? '',
//     title: movie?.title ?? movie?.name,
//     year: movie?.release_date ?? '???',
//     image: `https://image.tmdb.org/t/p/w500/${movie.poster_path}` ?? 'https://www.prokerala.com/movies/assets/img/no-poster-available.jpg',
//     searchParameter: movie?.id,
//     type: movie?.media_type
//   }))
// }

function timeConvert (n) {
  const num = n
  const hours = (num / 60)
  const rhours = Math.floor(hours)
  const minutes = (hours - rhours) * 60
  const rminutes = Math.round(minutes)
  return rhours > 0 ? rhours + 'h' + ' ' + rminutes + 'm' : rminutes + 'm'
}

export async function getImage (media) {
  const response = await fetch(END_POINTS.images(media.query, media.type), options)
  const data = await response.json()
  const background = await data?.backdrops[0].file_path ?? ''
  const logo = await data?.logos[0].file_path ?? ''

  return { background: `https://image.tmdb.org/t/p/original/${background}`, logo: `https://image.tmdb.org/t/p/original/${logo}` }
}

// export function extractProviders (params) {
//   Providers.results.forEach(element => {
//     console.log(element.provider_name)
//   })}
